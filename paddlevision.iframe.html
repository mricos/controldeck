<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaddleVision</title>
    <style>
        /* CSS Token Fallbacks - overridden by parent injection */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --border: #333333;
            --border-visible: #444444;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-muted: #666666;
            --accent-primary: #4ecdc4;
            --success: #00ff88;
            --error: #ff4444;
            --font-code: 'SF Mono', 'Monaco', 'Courier New', monospace;
            --curve-sm: 4px;
            --gap-sm: 8px;
            --gap-md: 12px;
            --tempo-fast: 0.15s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        ::-webkit-scrollbar { width: 6px; background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-visible); border-radius: 3px; }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: var(--font-code);
            font-size: 12px;
            padding: 12px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .title {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--accent-primary);
        }
        .status {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: var(--curve-sm);
            background: var(--bg-tertiary);
        }
        .status.running { color: var(--success); }
        .status.stopped { color: var(--text-muted); }

        .values {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-sm);
            margin-bottom: 12px;
        }
        .value-box {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--curve-sm);
            padding: var(--gap-sm);
            text-align: center;
        }
        .value-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .value-num {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
        }
        .value-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .value-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.05s;
        }

        .controls {
            display: flex;
            gap: var(--gap-sm);
            margin-bottom: 12px;
        }
        .btn {
            background: transparent;
            border: 1px solid var(--border-visible);
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: var(--curve-sm);
            font-family: inherit;
            transition: var(--tempo-fast);
            flex: 1;
        }
        .btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .btn.active { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); }

        .source-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px;
            font-size: 10px;
            font-family: inherit;
            border-radius: var(--curve-sm);
            flex: 1;
        }

        .log {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--curve-sm);
            padding: var(--gap-sm);
            font-size: 10px;
            max-height: 100px;
            overflow-y: auto;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="title">PaddleVision</span>
        <span class="status stopped" id="status">Stopped</span>
    </div>

    <div class="values">
        <div class="value-box">
            <div class="value-label">X</div>
            <div class="value-num" id="val-x">--</div>
            <div class="value-bar"><div class="value-bar-fill" id="bar-x"></div></div>
        </div>
        <div class="value-box">
            <div class="value-label">Y</div>
            <div class="value-num" id="val-y">--</div>
            <div class="value-bar"><div class="value-bar-fill" id="bar-y"></div></div>
        </div>
        <div class="value-box">
            <div class="value-label">Theta</div>
            <div class="value-num" id="val-theta">--</div>
            <div class="value-bar"><div class="value-bar-fill" id="bar-theta"></div></div>
        </div>
        <div class="value-box">
            <div class="value-label">Spread</div>
            <div class="value-num" id="val-spread">--</div>
            <div class="value-bar"><div class="value-bar-fill" id="bar-spread"></div></div>
        </div>
    </div>

    <div class="controls">
        <select class="source-select" id="source-select">
            <option value="mock">Mock (Sine)</option>
            <option value="asciivision">ASCIIVision</option>
        </select>
        <button class="btn" id="btn-start">Start</button>
        <button class="btn" id="btn-stop">Stop</button>
    </div>

    <div class="log" id="log">Ready</div>

    <!-- PaddleVision modular adapter -->
    <script src="src/adapters/paddlevision/derivers.js"></script>
    <script src="src/adapters/paddlevision/processors/base.js"></script>
    <script src="src/adapters/paddlevision/processors/extract.js"></script>
    <script src="src/adapters/paddlevision/processors/calibrate.js"></script>
    <script src="src/adapters/paddlevision/processors/smooth.js"></script>
    <script src="src/adapters/paddlevision/processors/flick-detect.js"></script>
    <script src="src/adapters/paddlevision/pipeline.js"></script>
    <script src="src/adapters/paddlevision/sources/base.js"></script>
    <script src="src/adapters/paddlevision/sources/asciivision.js"></script>
    <script src="src/adapters/paddlevision/sources/mock.js"></script>
    <script src="src/adapters/paddlevision/sinks/base.js"></script>
    <script src="src/adapters/paddlevision/sinks/hub.js"></script>
    <script src="src/adapters/paddlevision/sinks/events.js"></script>
    <script src="src/adapters/paddlevision/sinks/console.js"></script>
    <script src="src/adapters/paddlevision/builder.js"></script>
    <script src="src/adapters/paddlevision/adapter.js"></script>
    <script src="src/adapters/paddlevision/index.js"></script>

    <script>
    (function() {
        'use strict';

        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        let pv = null;
        let logCount = 0;

        // =========================================================
        // TETRA DATA PROTOCOL (TDP) - postMessage binding
        // =========================================================
        const TDP = {
            _v: 1,
            _idCounter: 0,
            _iframeId: 'paddlevision',

            init: function() {
                window.addEventListener('message', this._onMessage.bind(this));
                this.send('tetra/system/ready', 'event', { event: 'ready', data: { from: 'paddlevision.iframe' } });
                log('TDP ready');
            },

            // Generate unique packet ID
            _genId: function() {
                return 'pv-' + Date.now().toString(36) + '-' + (this._idCounter++).toString(36);
            },

            // Send TDP packet to parent
            send: function(topic, type, payload) {
                if (window.parent === window) return;

                window.parent.postMessage({
                    _proto: 'tdp',
                    _v: this._v,
                    _t: Date.now() / 1000,
                    _id: this._genId(),
                    topic: topic,
                    type: type,
                    payload: payload,
                    _browser: {
                        iframeId: this._iframeId,
                        origin: location.origin
                    }
                }, '*');
            },

            // Handle incoming TDP packets
            _onMessage: function(e) {
                // Accept both TDP and legacy terrain format
                if (e.data?._proto === 'tdp') {
                    this._handleTDP(e.data);
                } else if (e.data?.source === 'terrain') {
                    // Legacy compatibility
                    this._handleLegacy(e.data);
                }
            },

            _handleTDP: function(pkt) {
                const { topic, type, payload } = pkt;

                // Route based on topic
                if (topic === 'tetra/paddlevision/command') {
                    switch (payload?.cmd) {
                        case 'start':
                            startPaddleVision(payload.args?.source || 'mock');
                            break;
                        case 'stop':
                            stopPaddleVision();
                            break;
                        case 'setSource':
                            document.getElementById('source-select').value = payload.args?.source || 'mock';
                            break;
                    }
                } else if (topic === 'tetra/paddlevision/query') {
                    // Respond to state query
                    this.send('tetra/paddlevision/state', 'state', {
                        version: Date.now(),
                        state: { values: getValues(), running: pv?.isRunning() }
                    });
                } else if (topic === 'tetra/system/tokens') {
                    // CSS token injection
                    if (payload?.tokens) {
                        Object.entries(payload.tokens).forEach(([k, v]) => {
                            document.documentElement.style.setProperty(k, v);
                        });
                    }
                }
            },

            _handleLegacy: function(msg) {
                // Bridge legacy terrain messages to TDP handling
                const { type, payload } = msg;
                switch (type) {
                    case 'start':
                        startPaddleVision(payload?.source || 'mock');
                        break;
                    case 'stop':
                        stopPaddleVision();
                        break;
                    case 'tokens':
                        if (payload?.tokens) {
                            Object.entries(payload.tokens).forEach(([k, v]) => {
                                document.documentElement.style.setProperty(k, v);
                            });
                        }
                        break;
                }
            }
        };

        // =========================================================
        // CUSTOM SINK - Updates UI and sends to parent via TDP
        // =========================================================
        // Defined as factory to avoid class extension timing issues
        function createIframeSink() {
            const SinkAdapter = ControlDeck.PaddleVision.SinkAdapter;

            class IframeSink extends SinkAdapter {
                async connect() {
                    this._connected = true;
                    return true;
                }
                disconnect() {
                    this._connected = false;
                }
                emit(control, value, topic, extra) {
                    // Update local UI
                    updateValue(control, value);

                    // Send to parent via TDP
                    // Topic: tetra/hand/{side}/{control}
                    const tdpTopic = 'tetra/hand/right/' + control.replace('hand-', '');
                    TDP.send(tdpTopic, 'control', {
                        control: control,
                        value: value,
                        raw: extra?.raw
                    });
                }
            }
            return new IframeSink();
        }

        // =========================================================
        // UI HELPERS
        // =========================================================
        function log(msg) {
            logCount++;
            if (logCount > 20) {
                logEl.innerHTML = '';
                logCount = 1;
            }
            logEl.innerHTML += msg + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateValue(name, value) {
            const map = {
                'hand-x': 'x',
                'hand-y': 'y',
                'hand-theta': 'theta',
                'hand-spread': 'spread'
            };
            const key = map[name];
            if (!key) return;

            const el = document.getElementById('val-' + key);
            const bar = document.getElementById('bar-' + key);
            if (el) el.textContent = value.toFixed(2);
            if (bar) bar.style.width = (value * 100) + '%';
        }

        function getValues() {
            return pv ? pv.getValues() : { x: 0, y: 0, theta: 0, spread: 0 };
        }

        // =========================================================
        // PADDLEVISION CONTROL
        // =========================================================
        function startPaddleVision(sourceType) {
            if (pv && pv.isRunning()) {
                stopPaddleVision();
            }

            log('Starting with source: ' + sourceType);

            try {
                pv = ControlDeck.createPaddleVision()
                    .fromSource(sourceType, { pattern: 'sine', frameRate: 30 })
                    .withSink(createIframeSink())
                    .build();

                pv.start();

                statusEl.textContent = 'Running';
                statusEl.className = 'status running';

                // Notify parent via TDP
                TDP.send('tetra/paddlevision/status', 'event', {
                    event: 'started',
                    data: { source: sourceType }
                });

            } catch (e) {
                log('Error: ' + e.message);
                console.error(e);
            }
        }

        function stopPaddleVision() {
            if (pv) {
                pv.stop();
                pv = null;
            }
            statusEl.textContent = 'Stopped';
            statusEl.className = 'status stopped';

            // Notify parent via TDP
            TDP.send('tetra/paddlevision/status', 'event', {
                event: 'stopped',
                data: {}
            });
            log('Stopped');
        }

        // =========================================================
        // UI EVENTS
        // =========================================================
        document.getElementById('btn-start').addEventListener('click', function() {
            const source = document.getElementById('source-select').value;
            startPaddleVision(source);
        });

        document.getElementById('btn-stop').addEventListener('click', function() {
            stopPaddleVision();
        });

        // =========================================================
        // INIT
        // =========================================================
        TDP.init();
        log('PaddleVision iframe ready');

    })();
    </script>
</body>
</html>
